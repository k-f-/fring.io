name: Content Update Pipeline

# Trigger when markdown content files change on main
# Designed for mobile editing: edit .md on GitHub.com → auto-regenerate → auto-deploy
on:
  push:
    branches:
      - main
    paths:
      - 'content/*.md'

permissions:
  contents: write
  actions: write

jobs:
  regenerate:
    runs-on: ubuntu-latest
    # Prevent infinite loops: skip if the commit was made by this workflow
    if: github.actor != 'github-actions[bot]'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Use a PAT or default token with write permissions
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Parse markdown to JSON
        run: |
          echo "=== Running content parsers ==="
          echo ""

          # Parse books.md → books.json
          if [ -f content/books.md ]; then
            echo "--- Parsing books.md ---"
            python3 infrastructure/parse_books.py
            echo ""
          fi

          # Parse albums.md → albums.json
          if [ -f content/albums.md ]; then
            echo "--- Parsing albums.md ---"
            python3 infrastructure/parse_albums.py
            echo ""
          fi

          # Parse now.md → now.json
          if [ -f content/now.md ]; then
            echo "--- Parsing now.md ---"
            python3 infrastructure/parse_now.py
            echo ""
          fi

      - name: Regenerate v4 HTML
        run: |
          echo "=== Regenerating v4 site ==="
          python3 infrastructure/regenerate_v4_html.py

      - name: Check for changes
        id: changes
        run: |
          git diff --quiet content/*.json sites/v4/index.html && echo "changed=false" >> $GITHUB_OUTPUT || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit generated files
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add content/*.json sites/v4/index.html
          git commit -m "chore: regenerate site from content update

          Auto-generated by content-update pipeline.
          Triggered by: ${{ github.sha }}"

          git push

      - name: Trigger deployment
        if: steps.changes.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy.yml',
              ref: 'main',
              inputs: {
              version: 'v4'
            });
            console.log('✅ Triggered deploy.yml for v4');

      - name: Summary
        run: |
          echo "## Content Update Pipeline" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.changes.outputs.changed }}" == "true" ]]; then
            echo "✅ Content regenerated and deployment triggered" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Parsed markdown → JSON" >> $GITHUB_STEP_SUMMARY
            echo "- Regenerated sites/v4/index.html" >> $GITHUB_STEP_SUMMARY
            echo "- Committed generated files" >> $GITHUB_STEP_SUMMARY
            echo "- Triggered deploy.yml for v4" >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ No changes detected in generated files" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Markdown was updated but generated output is identical." >> $GITHUB_STEP_SUMMARY
          fi
