name: Deploy to S3

on:
  push:
    branches:
      - main
      - 'v*.fring.io'  # Matches branches like v4.fring.io, v5.fring.io, etc.
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment target (main or version like v4)'
        required: true
        default: 'main'

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Determine deployment target
        id: target
        run: |
          # Extract version from branch name or use 'main'
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"

          if [[ "$BRANCH_NAME" == "main" ]]; then
            echo "bucket=fring.io" >> $GITHUB_OUTPUT
            echo "distribution_id=${{ secrets.CLOUDFRONT_DISTRIBUTION_MAIN }}" >> $GITHUB_OUTPUT
            echo "is_main=true" >> $GITHUB_OUTPUT
          else
            # Branch name like "v4.fring.io" becomes bucket "v4.fring.io"
            echo "bucket=${BRANCH_NAME}" >> $GITHUB_OUTPUT
            echo "distribution_id=${{ secrets.CLOUDFRONT_DISTRIBUTION_MAIN }}" >> $GITHUB_OUTPUT
            echo "is_main=false" >> $GITHUB_OUTPUT
          fi

          echo "Deploying to bucket: ${BUCKET}"

      - name: Sync files to S3
        run: |
          BUCKET="${{ steps.target.outputs.bucket }}"

          aws s3 sync . s3://${BUCKET}/ \
            --exclude ".git/*" \
            --exclude ".github/*" \
            --exclude "*.md" \
            --exclude "SECURITY_REMEDIATION.md" \
            --exclude "*.sh" \
            --delete \
            --cache-control "public, max-age=3600"

          # Set longer cache for static assets
          aws s3 cp s3://${BUCKET}/css s3://${BUCKET}/css \
            --recursive \
            --cache-control "public, max-age=31536000, immutable" \
            --metadata-directive REPLACE

      - name: Invalidate CloudFront cache
        if: steps.target.outputs.distribution_id != ''
        run: |
          DISTRIBUTION_ID="${{ steps.target.outputs.distribution_id }}"

          aws cloudfront create-invalidation \
            --distribution-id ${DISTRIBUTION_ID} \
            --paths "/*"

      - name: Update Route53 for main deployment
        if: steps.target.outputs.is_main == 'true'
        run: |
          HOSTED_ZONE_ID="${{ secrets.ROUTE53_HOSTED_ZONE_ID }}"

          # Create JSON for Route53 change batch
          cat > /tmp/route53-changes.json <<EOF
          {
            "Changes": [
              {
                "Action": "UPSERT",
                "ResourceRecordSet": {
                  "Name": "fring.io",
                  "Type": "A",
                  "AliasTarget": {
                    "HostedZoneId": "Z2FDTNDATAQYW2",
                    "DNSName": "${{ secrets.CLOUDFRONT_DOMAIN_MAIN }}",
                    "EvaluateTargetHealth": false
                  }
                }
              },
              {
                "Action": "UPSERT",
                "ResourceRecordSet": {
                  "Name": "www.fring.io",
                  "Type": "A",
                  "AliasTarget": {
                    "HostedZoneId": "Z2FDTNDATAQYW2",
                    "DNSName": "${{ secrets.CLOUDFRONT_DOMAIN_MAIN }}",
                    "EvaluateTargetHealth": false
                  }
                }
              }
            ]
          }
          EOF

          aws route53 change-resource-record-sets \
            --hosted-zone-id ${HOSTED_ZONE_ID} \
            --change-batch file:///tmp/route53-changes.json

      - name: Deployment summary
        run: |
          echo "âœ… Deployment successful!"
          echo "Bucket: ${{ steps.target.outputs.bucket }}"
          if [[ "${{ steps.target.outputs.is_main }}" == "true" ]]; then
            echo "URLs: https://fring.io, https://www.fring.io"
          else
            echo "URL: https://${{ steps.target.outputs.bucket }}"
          fi
