name: Deploy to S3

on:
  push:
    branches:
      - main
    paths:
      - 'sites/**'  # Only deploy when site content changes
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., v4, v3, v2, v1)'
        required: true
        default: 'v4'

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  LATEST_VERSION: v4  # Update this when you create v5, v6, etc.

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Detect changed versions
        id: changed
        run: |
          # Get list of changed files
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Manual dispatch - use input
            VERSION="${{ github.event.inputs.version }}"
          else
            # Auto-deploy - detect from changed files
            CHANGED=$(git diff --name-only HEAD~1 HEAD)
            VERSION=$(echo "$CHANGED" | grep '^sites/v' | cut -d'/' -f2 | sort -u)
          fi

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Deploying version: ${VERSION}"

      - name: Sync to versioned S3 bucket
        run: |
          VERSION="${{ steps.changed.outputs.version }}"

          # Deploy to versioned bucket (e.g., s3://v4.fring.io/)
          aws s3 sync sites/${VERSION}/ s3://${VERSION}.fring.io/ \
            --delete \
            --cache-control "public, max-age=3600"

          # Set longer cache for static assets
          if aws s3 ls s3://${VERSION}.fring.io/css/ 2>/dev/null; then
            aws s3 cp s3://${VERSION}.fring.io/css s3://${VERSION}.fring.io/css \
              --recursive \
              --cache-control "public, max-age=31536000, immutable" \
              --metadata-directive REPLACE
          fi

      - name: Sync to main bucket (if latest version)
        if: steps.changed.outputs.version == env.LATEST_VERSION
        run: |
          VERSION="${{ steps.changed.outputs.version }}"

          # Also deploy to main bucket so apex domains show latest
          aws s3 sync sites/${VERSION}/ s3://fring.io/ \
            --delete \
            --cache-control "public, max-age=3600"

          # Set longer cache for static assets
          if aws s3 ls s3://fring.io/css/ 2>/dev/null; then
            aws s3 cp s3://fring.io/css s3://fring.io/css \
              --recursive \
              --cache-control "public, max-age=31536000, immutable" \
              --metadata-directive REPLACE
          fi

      - name: Invalidate CloudFront cache
        if: steps.changed.outputs.version == env.LATEST_VERSION
        run: |
          # Invalidate CloudFront cache for apex domains
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_MAIN }} \
            --paths "/*"

      - name: Deployment summary
        run: |
          VERSION="${{ steps.changed.outputs.version }}"

          echo "‚úÖ Deployment successful!"
          echo "üì¶ Deployed: ${VERSION}"
          echo ""
          echo "üåê URLs:"
          echo "   - https://${VERSION}.fring.io (versioned)"
          echo "   - https://${VERSION}.kfring.com (redirects to ${VERSION}.fring.io)"

          if [[ "$VERSION" == "${{ env.LATEST_VERSION }}" ]]; then
            echo ""
            echo "   Also deployed to apex domains (latest version):"
            echo "   - https://fring.io"
            echo "   - https://www.fring.io"
            echo "   - https://kfring.com"
            echo "   - https://www.kfring.com"
          fi
