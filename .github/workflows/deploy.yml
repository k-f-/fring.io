name: Deploy to S3

on:
  push:
    branches:
      - main
    paths:
      - 'sites/**'  # Only deploy when site content changes
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., v4, v3, v2, v1)'
        required: true
        default: 'v4'

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  # IMPORTANT: When changing live version, also update:
  # - VERSION file in repo root
  # - README.md "Current Live Version" section
  LATEST_VERSION: v4

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need at least 2 commits for git diff HEAD~1

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Detect changed versions
        id: changed
        run: |
          # Get list of changed files
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Manual dispatch - use input
            VERSION="${{ github.event.inputs.version }}"
          else
            # Auto-deploy - detect from changed files (take latest version if multiple)
            CHANGED=$(git diff --name-only HEAD~1 HEAD)
            VERSION=$(echo "$CHANGED" | grep '^sites/v' | cut -d'/' -f2 | sort -Vu | tail -1)
          fi

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Deploying version: ${VERSION}"

      - name: Sync to versioned S3 bucket
        run: |
          VERSION="${{ steps.changed.outputs.version }}"

          # Determine source directory and target bucket
          #
          # ARCHITECTURE NOTE:
          # - v2, v3, v4: Use fring.io as primary domain
          #   - Deploy to: v2.fring.io, v3.fring.io buckets
          #   - Redirect buckets: v2.kfring.com, v3.kfring.com ‚Üí redirect to fring.io
          #
          # - v1: LEGACY - Uses kfring.com as primary domain
          #   - Jekyll site with hardcoded http://v1.kfring.com URLs in _config.yml
          #   - Deploy to: v1.kfring.com bucket (from _site/ directory)
          #   - Redirect bucket: v1.fring.io ‚Üí redirects to v1.kfring.com
          #
          if [[ "$VERSION" == "v1" ]]; then
            SOURCE_DIR="sites/v1/_site"
            BUCKET="${VERSION}.kfring.com"
          else
            SOURCE_DIR="sites/${VERSION}"
            BUCKET="${VERSION}.fring.io"
          fi

          # Deploy to versioned bucket (content hosting)
          # Note: Redirect buckets (v*.kfring.com, v1.fring.io) are empty and
          # managed manually via S3 website redirect configuration
          aws s3 sync ${SOURCE_DIR}/ s3://${BUCKET}/ \
            --delete \
            --cache-control "public, max-age=3600"

          # Set longer cache for static assets
          if aws s3 ls s3://${BUCKET}/css/ 2>/dev/null; then
            aws s3 cp s3://${BUCKET}/css s3://${BUCKET}/css \
              --recursive \
              --cache-control "public, max-age=31536000, immutable" \
              --metadata-directive REPLACE
          fi

      - name: Sync to main bucket (if latest version)
        if: steps.changed.outputs.version == env.LATEST_VERSION
        run: |
          VERSION="${{ steps.changed.outputs.version }}"

          # Determine source directory (v1 is Jekyll with _site subdirectory)
          if [[ "$VERSION" == "v1" ]]; then
            SOURCE_DIR="sites/v1/_site"
          else
            SOURCE_DIR="sites/${VERSION}"
          fi

          # Also deploy to main bucket so apex domains show latest
          aws s3 sync ${SOURCE_DIR}/ s3://fring.io/ \
            --delete \
            --cache-control "public, max-age=3600"

          # Set longer cache for static assets
          if aws s3 ls s3://fring.io/css/ 2>/dev/null; then
            aws s3 cp s3://fring.io/css s3://fring.io/css \
              --recursive \
              --cache-control "public, max-age=31536000, immutable" \
              --metadata-directive REPLACE
          fi

      - name: Invalidate CloudFront cache
        if: steps.changed.outputs.version == env.LATEST_VERSION
        run: |
          # Invalidate CloudFront cache for apex domains
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_MAIN }} \
            --paths "/*"

      - name: Deployment summary
        run: |
          VERSION="${{ steps.changed.outputs.version }}"

          echo "‚úÖ Deployment successful!"
          echo "üì¶ Deployed: ${VERSION}"
          echo ""
          echo "üåê URLs:"

          if [[ "$VERSION" == "v1" ]]; then
            echo "   - https://v1.kfring.com (primary)"
            echo "   - https://v1.fring.io (redirects to v1.kfring.com)"
          else
            echo "   - https://${VERSION}.fring.io (primary)"
            echo "   - https://${VERSION}.kfring.com (redirects to ${VERSION}.fring.io)"
          fi

          if [[ "$VERSION" == "${{ env.LATEST_VERSION }}" ]]; then
            echo ""
            echo "   Also deployed to apex domains (latest version):"
            echo "   - https://fring.io (primary)"
            echo "   - https://www.fring.io (primary)"
            echo "   - https://kfring.com (redirects to fring.io)"
            echo "   - https://www.kfring.com (redirects to fring.io)"
          fi
